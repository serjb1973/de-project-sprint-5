# Проект 5-го спринта

### Описание
Репозиторий предназначен для сдачи проекта 5-го спринта

### Как работать с репозиторием
1. В вашем GitHub-аккаунте автоматически создастся репозиторий `de-project-sprint-5` после того, как вы привяжете свой GitHub-аккаунт на Платформе.
2. Скопируйте репозиторий на свой локальный компьютер, в качестве пароля укажите ваш `Access Token` (получить нужно на странице [Personal Access Tokens](https://github.com/settings/tokens)):
	* `git clone https://github.com/{{ username }}/de-project-sprint-5.git`
3. Перейдите в директорию с проектом: 
	* `cd de-project-sprint-5`
4. Выполните проект и сохраните получившийся код в локальном репозитории:
	* `git add .`
	* `git commit -m 'my best commit'`
5. Обновите репозиторий в вашем GutHub-аккаунте:
	* `git push origin main`

### Структура репозитория
- `/src/dags`

### Как запустить контейнер
Запустите локально команду:

```
docker run \
-d \
-p 3000:3000 \
-p 3002:3002 \
-p 15432:5432 \
cr.yandex/crp1r8pht0n0gl25aug1/de-pg-cr-af:latest
```

После того как запустится контейнер, вам будут доступны:
- Airflow
	- `localhost:3000/airflow`
- БД
	- `jovyan:jovyan@localhost:15432/de`
## 1. Список полей, которые необходимы для витрины.
#### cdm.dm_courier_ledger
* id — идентификатор записи.
* courier_id — ID курьера, которому перечисляем.
* courier_name — Ф. И. О. курьера.
* settlement_year — год отчёта.
* settlement_month — месяц отчёта, где 1 — январь и 12 — декабрь.
* orders_count — количество заказов за период (месяц).
* orders_total_sum — общая стоимость заказов.
* rate_avg — средний рейтинг курьера по оценкам пользователей.
* order_processing_fee — сумма, удержанная компанией за обработку заказов, которая высчитывается как orders_total_sum * 0.25.
* courier_order_sum — сумма, которую необходимо перечислить курьеру за доставленные им/ей заказы. За каждый доставленный заказ курьер должен получить некоторую сумму в зависимости от рейтинга (см. ниже).
* courier_tips_sum — сумма, которую пользователи оставили курьеру в качестве чаевых.
* courier_reward_sum — сумма, которую необходимо перечислить курьеру. Вычисляется как courier_order_sum + courier_tips_sum * 0.95 (5% — комиссия за обработку платежа).

Правила расчёта процента выплаты курьеру в зависимости от рейтинга, где r — это средний рейтинг курьера в расчётном месяце:
* r < 4 — 5% от заказа, но не менее 100 р.;
* 4 <= r < 4.5 — 7% от заказа, но не менее 150 р.;
* 4.5 <= r < 4.9 — 8% от заказа, но не менее 175 р.;
* 4.9 <= r — 10% от заказа, но не менее 200 р.

## 2. Список таблиц в слое DDS, из которых вы возьмёте поля для витрины.
### 2.1 список таблиц и полей которые уже есть в системе
#### dds.dm_orders
#### dds.dm_timestamp
* settlement_year — год отчёта.
* settlement_month — месяц отчёта, где 1 — январь и 12 — декабрь.
* orders_count — количество заказов за период (месяц).
* orders_total_sum — общая стоимость заказов.
* order_processing_fee — сумма, удержанная компанией за обработку заказов, которая высчитывается как orders_total_sum * 0.25.

### 2.2 список таблиц и полей которые надо добавить
####  dds.dm_couriers
* id
* courier_id — ID курьера, которому перечисляем.
* courier_name — Ф. И. О. курьера.
* active_from
* active_to
####  dds.dm_deliveries
* id
* courier_id foreign key on dds.dm_couriers
* order_id — ID заказа.
* order_ts
* delivery_ts
* sum
* tip_sum
* rate
### 3 На основе списка таблиц в DDS составьте список сущностей и полей, которые необходимо загрузить из API
#### get deliveries
* order_id
* order_ts
* delivery_id
* courier_id
* delivery_ts
* rate
* sum
* tip_sum
#### get couriers
* courier_id
* courier_name
